# CI/CDå¤±è´¥è‡ªæ„ˆæœºåˆ¶ï¼ˆCopilotæ•‘åœºå®å½•ï¼‰

**ä½œè€…**: Cline | **å‘å¸ƒæ—¥æœŸ**: 2025-10-24 | **åˆ†ç±»**: `æ ¸å¿ƒæŠ€æœ¯æ ˆ` `CI/CD` `DevOps` `AI`

**æ‘˜è¦**: ä¸€æ¡è„†å¼±çš„CI/CDæµæ°´çº¿æ˜¯æ½œä¼åœ¨é¡¹ç›®ä¸­çš„å®šæ—¶ç‚¸å¼¹ï¼Œå®ƒå¯èƒ½åœ¨æ·±å¤œçš„ä¸€æ¬¡å¸¸è§„éƒ¨ç½²ä¸­å¼•çˆ†ï¼Œå¸¦æ¥ç¾éš¾æ€§çš„åæœã€‚æœ¬æ–‡é€šè¿‡ä¸€æ¬¡æƒŠå¿ƒåŠ¨é­„çš„â€œCopilotæ·±å¤œæ•‘åœºâ€å®å½•ï¼Œä¸ä»…å±•ç¤ºäº†å¦‚ä½•åˆ©ç”¨AIå·¥å…·å¿«é€Ÿå®šä½å¹¶ä¿®å¤ç”±ä¸€æ¬¡å¤±è´¥éƒ¨ç½²å¼•å‘çš„ç”Ÿäº§ç¯å¢ƒæ•…éšœï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬å°†ä»¥æ­¤ä¸ºå¥‘æœºï¼Œä»é›¶å¼€å§‹æ„å»ºä¸€å¥—å…·å¤‡â€œè‡ªæ„ˆâ€èƒ½åŠ›çš„CI/CDæµæ°´çº¿ï¼Œå®ç°éƒ¨ç½²å¤±è´¥åçš„è‡ªåŠ¨å›æ»šå’Œæ™ºèƒ½å‘Šè­¦ï¼Œå°†æ½œåœ¨çš„ç”Ÿäº§äº‹æ•…æ‰¼æ€åœ¨æ‘‡ç¯®ä¹‹ä¸­ã€‚

**SEOå…³é”®è¯**: CI/CDå¤±è´¥è‡ªæ„ˆ, è‡ªåŠ¨å›æ»šç­–ç•¥, GitLab CI, GitHub Actions, Copilot Debug, ç”Ÿäº§ç¯å¢ƒéƒ¨ç½², DevOpsæœ€ä½³å®è·µ, éƒ¨ç½²åå¥åº·æ£€æŸ¥

---

## ç¬¬1éƒ¨åˆ†ï¼šè„†å¼±CI/CDæµæ°´çº¿çš„å‰–æ

åœ¨å¾ˆå¤šå¿«é€Ÿè¿­ä»£çš„é¡¹ç›®ä¸­ï¼ŒCI/CDæµæ°´çº¿è¢«ç®€å•åœ°è®¾è®¡ä¸ºâ€œæ„å»º-æµ‹è¯•-éƒ¨ç½²â€ä¸‰éƒ¨æ›²ï¼Œçœ‹ä¼¼é«˜æ•ˆï¼Œå®åˆ™æš—è—é£é™©ã€‚è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå…¸å‹çš„ï¼Œä½†å……æ»¡éšæ‚£çš„ GitLab CI é…ç½®æ–‡ä»¶ã€‚

**åœºæ™¯**: ä¸€ä¸ªNode.js Expressåº”ç”¨ï¼Œä½¿ç”¨Dockerè¿›è¡Œå®¹å™¨åŒ–éƒ¨ç½²ã€‚

```yaml
# .gitlab-ci.yml (è„†å¼±ç‰ˆæœ¬)

stages:
  - build
  - test
  - deploy

variables:
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA

build_job:
  stage: build
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $IMAGE_TAG .
    - docker push $IMAGE_TAG
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

test_job:
  stage: test
  image: node:18-alpine
  script:
    - npm install
    - npm test # å•å…ƒæµ‹è¯•
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

deploy_job:
  stage: deploy
  image: alpine:latest
  before_script:
    # å®‰è£…SSHå®¢æˆ·ç«¯å’Œç§é’¥
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - echo "Deploying to production server..."
    - ssh user@your-server.com "
        docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY &&
        docker pull $IMAGE_TAG &&
        docker stop my-app-container || true &&
        docker rm my-app-container || true &&
        docker run -d --name my-app-container -p 3000:3000 $IMAGE_TAG
      "
    - echo "Deployment finished."
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
```

**è¿™æ¡æµæ°´çº¿çš„è‡´å‘½ç¼ºé™·**:
1.  **ç›²ç›®è‡ªä¿¡çš„éƒ¨ç½²**: `deploy_job`è„šæœ¬æ‰§è¡Œå®Œ`docker run`å‘½ä»¤åå°±å®£å‘ŠæˆåŠŸã€‚å®ƒå®Œå…¨ä¸çŸ¥é“åº”ç”¨æ˜¯å¦åœ¨å®¹å™¨å†…æˆåŠŸå¯åŠ¨ï¼Œæˆ–è€…å¯åŠ¨åæ˜¯å¦å› ä¸ºä¸€ä¸ªè‡´å‘½é”™è¯¯è€Œç«‹å³å´©æºƒã€‚
2.  **æ²¡æœ‰å›å¤´è·¯**: ä¸€æ—¦éƒ¨ç½²äº†æœ‰é—®é¢˜çš„é•œåƒï¼Œæµæ°´çº¿ä¸ä¼šä¹Ÿæ— æ³•è¿›è¡Œä»»ä½•è¡¥æ•‘æªæ–½ã€‚å”¯ä¸€çš„æ¢å¤æ–¹å¼æ˜¯äººå·¥ä»‹å…¥ï¼Œæ‰‹åŠ¨é‡æ–°éƒ¨ç½²ä¸Šä¸€ä¸ªæ­£å¸¸çš„ç‰ˆæœ¬ï¼Œè€Œè¿™åœ¨æ·±å¤œæ—¶åˆ†å¯èƒ½æ˜¯è‡´å‘½çš„ã€‚
3.  **æµ‹è¯•è¦†ç›–ä¸è¶³**: å•å…ƒæµ‹è¯•(`npm test`)å¯èƒ½å…¨éƒ¨é€šè¿‡ï¼Œä½†æ— æ³•æ•æ‰åˆ°ç¯å¢ƒé…ç½®é”™è¯¯ã€æ•°æ®åº“è¿æ¥å¤±è´¥æˆ–å¯åŠ¨è„šæœ¬ä¸­çš„é€»è¾‘ç‚¸å¼¹ã€‚
4.  **é™é»˜çš„å¤±è´¥**: å¦‚æœ`docker run`åå®¹å™¨ç§’é€€ï¼ŒGitLab CIçš„æ—¥å¿—åªä¼šæ˜¾ç¤ºâ€œDeployment finishedâ€ï¼Œè¿ç»´äººå‘˜å¯èƒ½è¦ç­‰åˆ°ç”¨æˆ·åé¦ˆåæ‰å‘ç°æœåŠ¡å·²ç»ä¸­æ–­ã€‚

---

## ç¬¬2éƒ¨åˆ†ï¼šæ•…éšœåœºæ™¯ï¼šåˆå¤œçš„å‘Šè­¦

**æ—¶é—´**: å‡Œæ™¨ 2:00ã€‚
**äº‹ä»¶**: ä¸€ä½å‹¤å¥‹çš„å¼€å‘è€…åˆå¹¶äº†ä¸€ä¸ªç´§æ€¥ä¿®å¤åˆ°`main`åˆ†æ”¯ï¼Œè§¦å‘äº†CI/CDæµæ°´çº¿ã€‚

**å¼•å…¥çš„Bug**:
å¼€å‘è€…åœ¨ä»£ç ä¸­ä¸å°å¿ƒå°†æ•°æ®åº“è¿æ¥é…ç½®ä»ç¯å¢ƒå˜é‡è¯»å–æ”¹ä¸ºäº†ä¸€ä¸ªç¡¬ç¼–ç çš„ã€é”™è¯¯çš„æœ¬åœ°åœ°å€ã€‚
```javascript
// a/bad/commit.js
// é”™è¯¯ä¿®æ”¹å‰:
// const connectionString = process.env.DATABASE_URL;

// é”™è¯¯ä¿®æ”¹å:
const connectionString = "postgres://user:pass@localhost:5432/mydb"; // è‡´å‘½é”™è¯¯ï¼
```
è¿™ä¸ªä¿®æ”¹åœ¨æœ¬åœ°æµ‹è¯•æ—¶å¯èƒ½å› ä¸ºå¼€å‘è€…ç”µè„‘ä¸Šæ°å¥½æœ‰è¿™ä¸ªæ•°æ®åº“è€Œæœªè¢«å‘ç°ã€‚å•å…ƒæµ‹è¯•å› ä¸º`mock`äº†æ•°æ®åº“è¿æ¥ï¼Œä¹Ÿé¡ºåˆ©é€šè¿‡ã€‚

**éƒ¨ç½²è¿‡ç¨‹**:
1.  `build_job` æˆåŠŸæ„å»ºå¹¶æ¨é€äº†é•œåƒã€‚
2.  `test_job` æˆåŠŸè¿è¡Œäº†æ‰€æœ‰å•å…ƒæµ‹è¯•ã€‚
3.  `deploy_job` æˆåŠŸæ‰§è¡Œäº†æ‰€æœ‰`ssh`å‘½ä»¤ï¼Œæ‹‰å–äº†æ–°é•œåƒï¼Œå¹¶å¯åŠ¨äº†æ–°å®¹å™¨ã€‚ä»GitLab CIçš„è§†è§’çœ‹ï¼Œä¸€åˆ‡å®Œç¾ã€‚

**ç¾éš¾é™ä¸´**:
æ–°å®¹å™¨å¯åŠ¨åï¼ŒNode.jsåº”ç”¨å°è¯•è¿æ¥`localhost`çš„æ•°æ®åº“ï¼Œä½†å®¹å™¨å†…å¹¶æ²¡æœ‰æ•°æ®åº“ï¼Œè¿æ¥ç«‹åˆ»å¤±è´¥ï¼Œå¯¼è‡´è¿›ç¨‹å´©æºƒé€€å‡ºã€‚`docker run -d`å‘½ä»¤æœ¬èº«å·²æ‰§è¡Œå®Œæ¯•ï¼Œæ‰€ä»¥éƒ¨ç½²è„šæœ¬æ²¡æœ‰æŠ¥é”™ã€‚ä½†å®é™…ä¸Šï¼Œ`my-app-container`åœ¨å¯åŠ¨å0.5ç§’å°±é€€å‡ºäº†ã€‚

**ç›‘æ§ç³»ç»Ÿå‘Šè­¦**:
å‡Œæ™¨ 2:05ï¼ŒPrometheus + Alertmanager æ£€æµ‹åˆ°ç”Ÿäº§ç¯å¢ƒçš„WebæœåŠ¡å¥åº·æ£€æŸ¥ç«¯ç‚¹æŒç»­æ— å“åº”ï¼Œè§¦å‘äº†PagerDutyå‘Šè­¦ï¼Œå€¼ç­å·¥ç¨‹å¸ˆè¢«ä»ç¡æ¢¦ä¸­å«é†’ã€‚

**æ’æŸ¥æ—¥å¿—**:
å·¥ç¨‹å¸ˆç™»å½•æœåŠ¡å™¨ï¼Œæ‰§è¡Œ`docker ps -a`ï¼Œçœ‹åˆ°äº†ä»¤äººå¿ƒç¢çš„ä¸€å¹•ï¼š
```
CONTAINER ID   IMAGE                                 COMMAND                  CREATED          STATUS                      PORTS     NAMES
a1b2c3d4e5f6   registry.example.com/my-app:bad_sha   "docker-entrypoint.sâ€¦"   5 minutes ago    Exited (1) 5 minutes ago              my-app-container
```
`STATUS`æ˜¾ç¤º`Exited (1)`ï¼Œè¡¨æ˜å®¹å™¨å› é”™è¯¯é€€å‡ºã€‚æŸ¥çœ‹å®¹å™¨æ—¥å¿— `docker logs my-app-container`ï¼š
```
/app/node_modules/pg/lib/connection.js:55
  this.stream.connect(this.config.host, this.config.port);
               ^
Error: connect ECONNREFUSED 127.0.0.1:5432
    at TCPConnectWrap.afterConnect [as oncomplete] (node:net:1187:16) {
  errno: -111,
  code: 'ECONNREFUSED',
  syscall: 'connect',
  address: '127.0.0.1',
  port: 5432
}
```
æ—¥å¿—æ¸…æ™°åœ°æ˜¾ç¤ºäº†æ•°æ®åº“è¿æ¥è¢«æ‹’ç»ã€‚

---

## ç¬¬3éƒ¨åˆ†ï¼šCopilotæ•‘åœºï¼šè¯Šæ–­ä¸çƒ­ä¿®å¤

åœ¨å‹åŠ›ä¹‹ä¸‹ï¼Œå·¥ç¨‹å¸ˆå†³å®šå€ŸåŠ©AIå·¥å…·æ¥åŠ é€Ÿé—®é¢˜å®šä½ã€‚ä»–å°†æ—¥å¿—ç²˜è´´åˆ°IDEçš„Copilot Chatçª—å£ä¸­ã€‚

**ä¸Copilotçš„å¯¹è¯**:

**å·¥ç¨‹å¸ˆ**:
> My Node.js application container exits immediately after deployment. Here are the logs. What's the likely cause?
> ```
> /app/node_modules/pg/lib/connection.js:55
>   this.stream.connect(this.config.host, this.config.port);
>                ^
> Error: connect ECONNREFUSED 127.0.0.1:5432
> ...
> ```

**Copilot**:
> The error `Error: connect ECONNREFUSED 127.0.0.1:5432` indicates that your application is trying to connect to a PostgreSQL database at `localhost` (127.0.0.1) on port 5432, but the connection was refused.
>
> In a Docker container environment, `localhost` refers to the container itself, not the host machine or another container.
>
> The most likely causes are:
> 1.  **Incorrect Database Host**: The application is hard-coded to connect to `localhost`. In a multi-container setup (e.g., with Docker Compose), it should use the service name of the database container (e.g., `postgres`). For external databases, it should be the database's actual hostname or IP.
> 2.  **Missing or Incorrect Environment Variable**: The application is likely supposed to get the database connection string from an environment variable (like `DATABASE_URL`), but it's either not being passed to the container or it's incorrect.
>
> **Recommendation**: Check your application's database configuration logic. Search your recent commits for any changes related to database connection strings or environment variable handling.

**å®šä½é—®é¢˜**:
Copilotçš„åˆ†æç›´æŒ‡è¦å®³ã€‚å·¥ç¨‹å¸ˆç«‹åˆ»æ£€æŸ¥äº†æœ€è¿‘çš„gitæäº¤ï¼Œè¿…é€Ÿå‘ç°äº†é‚£ä¸ªé”™è¯¯çš„ç¡¬ç¼–ç æäº¤ã€‚

**ä¿®å¤**:
ä»–ç«‹å³å›æ»šäº†è¯¥æäº¤ï¼Œå¹¶æ¨é€äº†ä¸€ä¸ªæ–°çš„ä¿®å¤commitã€‚ä½†æ­¤æ—¶ï¼Œä»–æ„è¯†åˆ°å¿…é¡»æ”¹è¿›CI/CDæµç¨‹ï¼Œå¦åˆ™åŒæ ·çš„é—®é¢˜è¿˜ä¼šå†æ¬¡å‘ç”Ÿã€‚

---

## ç¬¬4éƒ¨åˆ†ï¼šæ„å»ºâ€œè‡ªæ„ˆâ€çš„CI/CDæµæ°´çº¿

äº¡ç¾Šè¡¥ç‰¢ï¼Œä¸ºæ—¶æœªæ™šã€‚æˆ‘ä»¬å°†å¯¹`.gitlab-ci.yml`è¿›è¡Œä¸€æ¬¡å½»åº•çš„å‡çº§ï¼Œèµ‹äºˆå®ƒè‡ªæˆ‘è¯Šæ–­å’Œä¿®å¤çš„èƒ½åŠ›ã€‚

### 4.1 å®æ–½éƒ¨ç½²åå¥åº·æ£€æŸ¥

éƒ¨ç½²çš„æ ¸å¿ƒåŸåˆ™æ˜¯ï¼š**éªŒè¯ï¼Œè€Œä¸è¦ä¿¡ä»»**ã€‚æˆ‘ä»¬åœ¨éƒ¨ç½²åå¿…é¡»ä¸»åŠ¨æ£€æŸ¥åº”ç”¨æ˜¯å¦çœŸçš„å¥åº·ã€‚

**ç¬¬ä¸€æ­¥**: åœ¨Node.jsåº”ç”¨ä¸­å¢åŠ ä¸€ä¸ªå¥åº·æ£€æŸ¥ç«¯ç‚¹ã€‚
```javascript
// app.js
app.get('/health', (req, res) => {
  // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤æ‚çš„æ£€æŸ¥ï¼Œå¦‚æ•°æ®åº“è¿æ¥
  res.status(200).send('OK');
});
```

**ç¬¬äºŒæ­¥**: ä¿®æ”¹`deploy_job`ï¼Œåœ¨`docker run`åå¢åŠ ä¸€ä¸ªæ£€æŸ¥è„šæœ¬ã€‚

```yaml
# deploy_jobçš„ä¸€éƒ¨åˆ†
script:
  - |
    ssh user@your-server.com << 'EOF'
      docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
      docker pull $IMAGE_TAG

      # ä¼˜é›…åœ°åœæ­¢æ—§å®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      if [ $(docker ps -q -f name=my-app-container) ]; then
        echo "Stopping old container..."
        docker stop my-app-container
        docker rm my-app-container
      fi

      echo "Starting new container..."
      docker run -d --name my-app-container -p 3000:3000 $IMAGE_TAG

      # --- å¥åº·æ£€æŸ¥å¼€å§‹ ---
      echo "Waiting for application to start..."
      sleep 10 # ç­‰å¾…åº”ç”¨å¯åŠ¨

      echo "Performing health check..."
      for i in {1..5}; do
        response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/health)
        if [ "$response" -eq 200 ]; then
          echo "Health check passed!"
          exit 0 # æˆåŠŸé€€å‡ºè„šæœ¬
        else
          echo "Health check failed (Attempt $i/5). Status code: $response. Retrying in 5 seconds..."
          sleep 5
        fi
      done

      echo "Application failed to start correctly."
      # å…³é”®ï¼šå¦‚æœå¥åº·æ£€æŸ¥æœ€ç»ˆå¤±è´¥ï¼Œè®©è„šæœ¬ä»¥éé›¶çŠ¶æ€ç é€€å‡º
      exit 1
    EOF
```
ç°åœ¨ï¼Œå¦‚æœåº”ç”¨å¯åŠ¨å¤±è´¥æˆ–å¥åº·æ£€æŸ¥ç«¯ç‚¹ä¸è¿”å›200ï¼Œ`deploy_job`å°†ä¼šå¤±è´¥ï¼Œæˆ‘ä»¬èƒ½ç«‹åˆ»åœ¨GitLab CIç•Œé¢ä¸Šçœ‹åˆ°çº¢è‰²çš„é”™è¯¯æ ‡è®°ã€‚

### 4.2 è®¾è®¡è‡ªåŠ¨å›æ»šç­–ç•¥

ä»…ä»…è®©éƒ¨ç½²å¤±è´¥æ˜¯ä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯è®©æœåŠ¡**ä¸ä¸­æ–­**ã€‚è¿™å°±éœ€è¦è‡ªåŠ¨å›æ»šã€‚

**ç­–ç•¥**:
1.  åœ¨éƒ¨ç½²å‰ï¼Œè·å–å½“å‰æ­£åœ¨è¿è¡Œçš„é•œåƒçš„IDã€‚
2.  å¦‚æœæ–°çš„éƒ¨ç½²å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œåˆ™ä½¿ç”¨ä¹‹å‰è·å–çš„IDé‡æ–°å¯åŠ¨æ—§çš„å®¹å™¨ã€‚

```yaml
# deploy_jobçš„æœ€ç»ˆç‰ˆæœ¬
script:
  - |
    ssh user@your-server.com << 'EOF'
      set -e # å…³é”®ï¼šä»»ä½•å‘½ä»¤å¤±è´¥éƒ½å°†ä¸­æ­¢è„šæœ¬

      docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

      # è·å–å½“å‰è¿è¡Œçš„é•œåƒIDï¼Œä½œä¸ºå›æ»šç‰ˆæœ¬
      OLD_IMAGE_ID=$(docker inspect my-app-container --format='{{.Image}}' || echo "")

      # æ‹‰å–æ–°é•œåƒ
      docker pull $IMAGE_TAG

      # åœæ­¢å¹¶ç§»é™¤æ—§å®¹å™¨
      if [ -n "$OLD_IMAGE_ID" ]; then
        docker stop my-app-container
        docker rm my-app-container
      fi

      # å¯åŠ¨æ–°å®¹å™¨
      echo "Deploying new version: $CI_COMMIT_SHORT_SHA"
      docker run -d --name my-app-container -p 3000:3000 $IMAGE_TAG

      # å¥åº·æ£€æŸ¥ (ä½¿ç”¨å‡½æ•°ï¼Œæ›´æ¸…æ™°)
      perform_health_check() {
        echo "Waiting for application..."
        sleep 10
        for i in {1..5}; do
          if curl -s --fail http://localhost:3000/health > /dev/null; then
            echo "Health check successful!"
            return 0
          fi
          echo "Health check attempt $i failed. Retrying..."
          sleep 5
        done
        return 1
      }

      # --- è‡ªæ„ˆé€»è¾‘ ---
      if ! perform_health_check; then
        echo "Deployment failed. Rolling back..."
        docker stop my-app-container
        docker rm my-app-container

        if [ -n "$OLD_IMAGE_ID" ]; then
          echo "Re-deploying previous version: $OLD_IMAGE_ID"
          docker run -d --name my-app-container -p 3000:3000 $OLD_IMAGE_ID
          echo "Rollback successful. Production is safe."
        else
          echo "No previous version to roll back to. Manual intervention required."
        fi
        # å³ä½¿å›æ»šæˆåŠŸï¼Œä¹Ÿè¦è®©CIä»»åŠ¡å¤±è´¥ï¼Œä»¥é€šçŸ¥å›¢é˜Ÿ
        exit 1
      fi

      echo "Deployment of $CI_COMMIT_SHORT_SHA successful."
    EOF
```

### 4.3 å¢åŠ æ™ºèƒ½å‘Šè­¦

æœ€åï¼Œæˆ‘ä»¬éœ€è¦è®©å›¢é˜Ÿæ¸…æ™°åœ°çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªç®€å•çš„è„šæœ¬ï¼Œåœ¨æµæ°´çº¿ä»»åŠ¡å¤±è´¥æ—¶å‘é€é€šçŸ¥åˆ°Slackã€‚

```yaml
# .gitlab-ci.yml (åœ¨deploy_jobåŒçº§æ·»åŠ )
notify_failure:
  stage: .post # åœ¨æ‰€æœ‰é˜¶æ®µä¹‹åè¿è¡Œ
  image: curlimages/curl:7.78.0
  script:
    - 'curl -X POST -H "Content-type: application/json" --data "{\"text\":\"ğŸš¨ Deployment to Production Failed! Pipeline: $CI_PIPELINE_URL. A rollback was attempted.\"}" $SLACK_WEBHOOK_URL'
  when: on_failure # ä»…åœ¨æµæ°´çº¿å¤±è´¥æ—¶è¿è¡Œ
```

---

## ç¬¬5éƒ¨åˆ†ï¼šè‡ªæ„ˆæµæ°´çº¿å®æˆ˜æ¼”ç»ƒ

ç°åœ¨ï¼Œæˆ‘ä»¬å†æ¬¡ç”¨é‚£ä¸ªæœ‰Bugçš„commitæ¥æµ‹è¯•æˆ‘ä»¬å…¨æ–°çš„ã€å…·å¤‡è‡ªæ„ˆèƒ½åŠ›çš„æµæ°´çº¿ã€‚

1.  å¼€å‘è€…æ¨é€äº†é”™è¯¯çš„æ•°æ®åº“è¿æ¥ä»£ç ã€‚
2.  `build`å’Œ`test`é˜¶æ®µç…§å¸¸é€šè¿‡ã€‚
3.  `deploy_job`å¼€å§‹æ‰§è¡Œï¼š
    -   æˆåŠŸè·å–äº†å½“å‰è¿è¡Œçš„ã€æ­£å¸¸çš„é•œåƒIDã€‚
    -   æ‹‰å–äº†æ–°çš„ã€æœ‰é—®é¢˜çš„é•œåƒã€‚
    -   åœæ­¢äº†æ—§å®¹å™¨ï¼Œå¯åŠ¨äº†æ–°å®¹å™¨ã€‚
    -   **å¥åº·æ£€æŸ¥å¼€å§‹**: `curl`å‘½ä»¤è¿ç»­5æ¬¡æ— æ³•ä»`http://localhost:3000/health`è·å–åˆ°200å“åº”ï¼Œå› ä¸ºåº”ç”¨å·²ç»å´©æºƒã€‚
    -   `perform_health_check`å‡½æ•°è¿”å›å¤±è´¥ã€‚
    -   **è‡ªåŠ¨å›æ»šè¢«è§¦å‘**: è„šæœ¬æ‰“å°å‡º "Deployment failed. Rolling back..."ã€‚
    -   æœ‰é—®é¢˜çš„å®¹å™¨è¢«åœæ­¢å’Œç§»é™¤ã€‚
    -   è„šæœ¬ä½¿ç”¨ä¹‹å‰ä¿å­˜çš„`OLD_IMAGE_ID`é‡æ–°å¯åŠ¨äº†æ­£å¸¸çš„å®¹å™¨ã€‚
    -   ç”Ÿäº§ç¯å¢ƒçš„æœåŠ¡åœ¨çŸ­æš‚ä¸­æ–­ï¼ˆçº¦1åˆ†é’Ÿï¼‰åè‡ªåŠ¨æ¢å¤ã€‚
    -   `deploy_job`ä»¥å¤±è´¥çŠ¶æ€ç»“æŸã€‚
4.  `notify_failure`ä»»åŠ¡è¢«è§¦å‘ï¼ŒSlacké¢‘é“æ”¶åˆ°å‘Šè­¦ï¼Œå›¢é˜Ÿæˆå‘˜è¢«å‘ŠçŸ¥éƒ¨ç½²å¤±è´¥å¹¶å·²å°è¯•å›æ»šï¼Œéœ€è¦è·Ÿè¿›æ£€æŸ¥ã€‚

**ç»“æœ**: ä¸€åœºæ½œåœ¨çš„ã€éœ€è¦æ•°å°æ—¶æ‰èƒ½ä¿®å¤çš„ç”Ÿäº§äº‹æ•…ï¼Œè¢«CI/CDæµæ°´çº¿åœ¨å‡ åˆ†é’Ÿå†…è‡ªåŠ¨æ§åˆ¶å’ŒåŒ–è§£äº†ã€‚

---

## ç»“è®º

ç°ä»£DevOpsæ–‡åŒ–çš„æ ¸å¿ƒä¸ä»…ä»…æ˜¯â€œå¿«â€ï¼Œæ›´æ˜¯â€œç¨³â€ã€‚ä¸€æ¡æˆç†Ÿçš„CI/CDæµæ°´çº¿åº”è¯¥æˆä¸ºè´¨é‡çš„æœ€åä¸€é“é˜²çº¿ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªè„†å¼±çš„æ‰§è¡Œå™¨ã€‚

-   **æ‹¥æŠ±â€œéªŒè¯â€æ–‡åŒ–**: éƒ¨ç½²æ“ä½œçš„æœ€åä¸€æ­¥æ°¸è¿œåº”è¯¥æ˜¯éªŒè¯å…¶ç»“æœã€‚
-   **è®¾è®¡â€œé¢„æ¡ˆâ€**: è‡ªåŠ¨åŒ–å›æ»šä¸æ˜¯å¤‡é€‰é¡¹ï¼Œè€Œæ˜¯å¿…éœ€å“ã€‚å®ƒèƒ½åœ¨é—®é¢˜å‘ç”Ÿæ—¶æœ€å¤§ç¨‹åº¦åœ°å‡å°æŸå¤±ã€‚
-   **å–„ç”¨AIåŠ©æ‰‹**:åƒCopilotè¿™æ ·çš„å·¥å…·åœ¨å¿«é€Ÿè¯Šæ–­å’Œç†è§£é™Œç”Ÿä»£ç /æ—¥å¿—æ—¶æ˜¯å¼ºå¤§çš„ç›Ÿå‹ï¼Œä½†å®ƒä»¬ä¸èƒ½æ›¿ä»£ä¸€ä¸ªå¥å£®çš„ã€è‡ªåŠ¨åŒ–çš„æµç¨‹ã€‚

é€šè¿‡å°†å¥åº·æ£€æŸ¥ã€è‡ªåŠ¨å›æ»šå’Œæ™ºèƒ½å‘Šè­¦é›†æˆåˆ°ä½ çš„CI/CDæµæ°´çº¿ä¸­ï¼Œä½ æ„å»ºçš„å°†ä¸ä»…ä»…æ˜¯è½¯ä»¶ï¼Œæ›´æ˜¯ä¸€ç§å¯¹è´¨é‡å’Œç¨³å®šæ€§çš„æ‰¿è¯ºã€‚

## å‚è€ƒèµ„æ–™

1.  [GitLab CI/CD Documentation](https://docs.gitlab.com/ee/ci/)
2.  [Martin Fowler: BlueGreenDeployment](https://martinfowler.com/bliki/BlueGreenDeployment.html)
3.  [GitHub Actions: Implementing a rollback strategy](https://docs.github.com/en/actions)
4.  [The Twelve-Factor App: Best practices for modern applications](https://12factor.net/)
